var myMap = new Map();
myMap.set("Механизированная разработка грунта и шурфовка на наличие существующих сетей", ["Обратная засыпка грунтом мест шурфовок"]);
myMap.set("Механизированная разработка грунта", ["Устройство песчаного основания под трубопровод", "Устройство песчаного основания под колодец", "Бестраншейная прокладка методом ГНБ полиэтиленового трубопровода", "Бестраншейная прокладка полиэтиленового трубопровода с протаскиванием в футляр методом ГНБ", "Бестраншейная прокладка методом ГНБ стального трубопровода", "Бестраншейная прокладка стального трубопровода с протаскиванием в футляр методом ГНБ"]);
myMap.set("Устройство песчаного основания под трубопровод", ["Укладка трубопровода на песчаное основание"]);
myMap.set("Устройство песчаного основания под колодец", ["Монтаж днища и рабочей части сборного железобетонного колодца"]);
myMap.set("Обратная засыпка грунтом мест шурфовок", ["Механизированная разработка грунта"]);
myMap.set("Обратная засыпка грунтом", ["---"]);
myMap.set("Устройство над трубопроводом защитного слоя из песка и обратная засыпка грунтом", ["Проведение гидравлического испытания напорного трубопровода на прочность и герметичность", "Проведение промывки и гидравлического испытания напорного трубопровода на прочность и герметичность"]);
myMap.set("Сварка полиэтиленового трубопровода в плеть", ["Бестраншейная прокладка методом ГНБ полиэтиленового трубопровода", "Бестраншейная прокладка полиэтиленового трубопровода с протаскиванием в футляр методом ГНБ"]);
myMap.set("Сварка полиэтиленового трубопровода и фасонных частей", ["Подбивка песком полиэтиленового трубопровода"]);
myMap.set("Сварка трубопровода с помощью электромуфты", ["Подбивка песком полиэтиленового трубопровода", "Устройство над трубопроводом защитного слоя из песка и обратная засыпка грунтом"]);
myMap.set("Сварка и укладка на песчаное основание полиэтиленового трубопровода с фасонными частями", ["Подбивка песком полиэтиленового трубопровода", "Устройство над трубопроводом защитного слоя из песка и обратная засыпка грунтом"]);
myMap.set("Сварка стального трубопровода в плеть", ["Бестраншейная прокладка методом ГНБ стального трубопровода", "Бестраншейная прокладка стального трубопровода с протаскиванием в футляр методом ГНБ"]);
myMap.set("Сварка стального трубопровода и фасонных частей", ["Подбивка песком стального трубопровода", "Нанесение антикоррозийной изоляции лентами поливинилхлоридными липкими в три слоя по слою праймера битумного на стальной трубопровод"]);
myMap.set("Сварка и укладка на песчаное основание стального трубопровода с фасонными частями", ["Подбивка песком стального трубопровода", "Устройство над трубопроводом защитного слоя из песка и обратная засыпка грунтом"]);
myMap.set("Сварка полиэтиленового трубопровода и фасонных частей, монтаж запорной арматуры в колодце", ["Проведение гидравлического испытания напорного трубопровода на прочность и герметичность", "Проведение промывки и гидравлического испытания напорного трубопровода на прочность и герметичность"]);
myMap.set("Сварка полиэтиленового трубопровода и фасонных частей, монтаж пожарного гидранта в колодце", ["Проведение гидравлического испытания напорного трубопровода на прочность и герметичность", "Проведение промывки и гидравлического испытания напорного трубопровода на прочность и герметичность"]);
myMap.set("Сварка стального трубопровода и фасонных частей, монтаж запорной арматуры в колодце", ["Нанесение антикоррозионной изоляции эмалью в два слоя по слою грунтовки на стальные поверхности трубопровода и фасонных частей в колодце"]);
myMap.set("Сварка стального трубопровода и фасонных частей, монтаж пожарного гидранта в колодце", ["Нанесение антикоррозионной изоляции эмалью в два слоя по слою грунтовки на стальные поверхности трубопровода и фасонных частей в колодце"]);
myMap.set("Устройство врезки в существующий полиэтиленовый трубопровод", ["Проведение гидравлического испытания напорного трубопровода на прочность и герметичность", "Проведение промывки и гидравлического испытания напорного трубопровода на прочность и герметичность"]);
myMap.set("Устройство врезки в существующий стальной трубопровод", ["Нанесение антикоррозионной изоляции эмалью в два слоя по слою грунтовки на стальные поверхности трубопровода"]);
myMap.set("Монтаж колонок управления задвижками", ["---"]);
myMap.set("Бестраншейная прокладка методом ГНБ полиэтиленового трубопровода", ["Монтаж полиэтиленовых фасонных частей трубопровода"]);
myMap.set("Бестраншейная прокладка полиэтиленового трубопровода с протаскиванием в футляр методом ГНБ", ["Заделка концов футляра"]);
myMap.set("Бестраншейная прокладка методом ГНБ стального трубопровода", ["Монтаж стальных фасонных частей трубопровода"]);
myMap.set("Бестраншейная прокладка стального трубопровода с протаскиванием в футляр методом ГНБ", ["Заделка концов футляра"]);
myMap.set("Заделка концов футляра", ["Обратная засыпка концов футляра"]);
myMap.set("Монтаж днища и рабочей части сборного железобетонного колодца", ["Монтаж плиты перекрытия и горловины сборного железобетонного колодца"]);
myMap.set("Монтаж плиты перекрытия и горловины сборного железобетонного колодца", ["Устройство оклеечной гидроизоляции наружной поверхности колодца, а также мест стыковок железобетонных элементов колодца"]);
myMap.set("Монтаж стремянок", ["---"]);
myMap.set("Монтаж опор под пожарные гидранты", ["---", "Монтаж пожарного гидранта в колодце"]);
myMap.set("Демонтаж", ["---"]);
myMap.set("Устройство оклеечной гидроизоляции стеклоизолом в два слоя по слою праймера битумного наружной поверхности колодца, а также мест стыковок железобетонных элементов колодца", ["Обратная засыпка пазух колодца"]);
myMap.set("Герметизация мест прохода полиэтиленового трубопровода через стенки колодца", ["Обратная засыпка пазух колодца"]);
myMap.set("Герметизация мест прохода стального через стенки колодца", ["Обратная засыпка пазух колодца"]);
myMap.set("Подготовка под изоляцию (очистка, обеспыливание, обезжиривание) металлических поверхностей", ["Огрунтовка металлических поверхностей"]);
myMap.set("Огрунтовка за один раз металлических поверхностей", ["Окраска металлических огрунтованных поверхностей"]);
myMap.set("Окраска в два слоя металлических огрунтованных поверхностей", ["---"]);
myMap.set("Нанесение антикоррозийной изоляции лентами поливинилхлоридными липкими в три слоя по слою праймера битумного на стальной трубопровод", ["Устройство над трубопроводом защитного слоя из песка и обратная засыпка грунтом", "Обратная засыпка грунтом"]);

function addSelect() {
    var select1Text = document.getElementById('work1').value;
    var select2 = document.getElementById('work2');
    select2.innerHTML = '';

    var arrayOption = myMap.get(select1Text);
    arrayOption.forEach(function(el) {
        var optionAdd = document.createElement('option');
        optionAdd.text = el;
        select2.appendChild(optionAdd);
    });
}

var projectSectionContainer = document.getElementById('projectSectionContainer');
let maxProjectSectionCounter = 0;
var divRow = projectSectionContainer.querySelectorAll('div[id^="projectSectionRow"]');

divRow.forEach(function (div) {
    var id = div.id;
    var divNumber = parseInt(id.replace('projectSectionRow', ''));
    if (divNumber > maxProjectSectionCounter) {
        maxProjectSectionCounter = divNumber;
    }
});

let projectSectionCounter = maxProjectSectionCounter + 1;

function addProjectSection() {

    const originalSection = document.querySelector("#projectSectionContainer .row");

    if (originalSection) {
        const newProjectSection = originalSection.cloneNode(true);

        newProjectSection.id = `projectSectionRow${projectSectionCounter}`;

        const select = newProjectSection.querySelector("select[name^='projectSectionSelect']");
        select.name = `projectSectionSelect${projectSectionCounter}`;

        const checkboxes = newProjectSection.querySelectorAll("input[type='checkbox'][name^='drawingCheckbox']");
        checkboxes.forEach(checkbox => {
            const nameParts = checkbox.name.split('-');

            if (nameParts.length > 1) {
                nameParts[nameParts.length - 1] = projectSectionCounter;
            } else {
                nameParts.push(projectSectionCounter);
            }

            checkbox.name = nameParts.join('-');
            checkbox.checked = false;
        });

        const toggleLink = newProjectSection.querySelector("a[href^='#collapseCardDrawings']");
        const newHrefId = `collapseCardDrawings${projectSectionCounter}`;
        toggleLink.href = `#${newHrefId}`;
        toggleLink.setAttribute("aria-controls", newHrefId);

        const collapseDiv = newProjectSection.querySelector("div.collapse[id^='collapseCardDrawings']");
        collapseDiv.id = newHrefId;

        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = `projectSectionHidden${projectSectionCounter}`;
        hiddenField.value = projectSectionCounter;
        newProjectSection.appendChild(hiddenField);

        select.addEventListener("change", function() {
            updateDrawings();
            saveSelectData();
        });

        document.getElementById('projectSectionContainer').appendChild(newProjectSection);
    }
    projectSectionCounter++;
}

function removeDiv(button) {
    var parentDiv = button.parentElement;
    if (parentDiv) {
        parentDiv.remove();
    }
}

document.addEventListener("DOMContentLoaded", function(event) {
    addSelect();
    restoreInputData();
    updateDrawings();

    const projectSectionSelects = document.querySelectorAll("select[name^='projectSectionSelect']");
    projectSectionSelects.forEach(select => {
        select.addEventListener("change", function() {
            updateDrawings();
            saveSelectData();
        });
    });
});

function updateDrawings() {
    const projectSectionSelects = document.querySelectorAll("select[name^='projectSectionSelect']");

    projectSectionSelects.forEach(select => {
        const selectedProjectSectionId = select.value;
        const sectionContainer = select.closest(".row");

        if (sectionContainer) {
            const drawingsContainer = sectionContainer.querySelector("div[id^='collapseCardDrawings']");
            const drawingCheckboxes = drawingsContainer.querySelectorAll("input[name^='drawingCheckbox']");

            drawingCheckboxes.forEach(checkbox => {
                if (checkbox.value === selectedProjectSectionId) {
                    checkbox.parentElement.style.display = "block";
                } else {
                    checkbox.parentElement.style.display = "none";
                    checkbox.checked = false;
                }
            });
        }
    });

    saveSelectData();
}

function saveSelectData() {
    const selects = document.querySelectorAll("select");
    const selectData = {};

    selects.forEach(select => {
        selectData[select.name] = select.value;
    });

    localStorage.setItem("selectedOptions", JSON.stringify(selectData));
}

function saveInputData() {
    const inputs = document.querySelectorAll("input[type='text'], input[type='checkbox']");
    const data = {};

    inputs.forEach(input => {
        if (input.type === "checkbox") {
            data[input.name] = input.checked;
        } else {
            data[input.name] = input.value;
        }
    });

    localStorage.setItem("formData", JSON.stringify(data));
    saveSelectData();
}

function restoreInputData() {
    const data = JSON.parse(localStorage.getItem("formData"));
    if (data) {
        Object.keys(data).forEach(name => {
            const input = document.querySelector(`input[name="${name}"]`);
            if (input) {
                if (input.type === "checkbox") {
                    input.checked = data[name];
                } else {
                    input.value = data[name];
                }
            }
        });
    }
    restoreSelectData();
}

function restoreSelectData() {
    const selectData = JSON.parse(localStorage.getItem("selectedOptions"));
    if (selectData) {
        const selects = document.querySelectorAll("select");
        selects.forEach(select => {
            if (selectData[select.name] !== undefined) {
                select.value = selectData[select.name];
            }
        });
    }
}

document.addEventListener("DOMContentLoaded", () => {
    restoreInputData();

    document.querySelectorAll("input[type='text'], input[type='checkbox']").forEach(input => {
        input.addEventListener(input.type === 'checkbox' ? "change" : "input", saveInputData);
    });

    document.querySelectorAll("select").forEach(select => {
        select.addEventListener("change", saveSelectData);
    });
});

function clearInputData() {
    localStorage.removeItem("formData");
    clearSelectData();
}

function clearSelectData() {
    localStorage.removeItem("selectedOptions");
}